#!/usr/bin/env node

const program = require("commander");
const { clone } = require("../lib/download.js");
const { promisify } = require('util');

// é…·ç‚«çš„æ–‡å­—å·¥å…·
const figlet = promisify(require('figlet'));
// æ¸…é™¤æ§åˆ¶å°
const clear = require('clear');
// ç»ˆç«¯å­—ç¬¦ä¸²ç¾åŒ–
const chalk = require('chalk');
const open = require('open');

const log = content => console.log(chalk.green(content));

const spawn = async (...args) => {
  // å­è¿›ç¨‹
  const { spawn } = require('child_process');

  return new Promise(resolve => {
      const proc = spawn(...args);
      // å­è¿›ç¨‹æˆåŠŸå¤±è´¥çš„æµå¯¼å…¥åˆ°ä¸»è¿›ç¨‹çš„æµä¸­
      proc.stdout.pipe(process.stdout);
      proc.stderr.pipe(process.stderr);
      // æ‰§è¡Œå®Œæˆ
      proc.on('close', () => {
          resolve();
      });
  })
};


program.action(async name => {
  name = name.args[0];
  
  clear();
  // æ‰“å°æ¬¢è¿ç”»é¢
  const data = await figlet('KKB Welcome');
  log(data);
  // åˆ›å»ºé¡¹ç›®
  log(`ğŸš€åˆ›å»ºé¡¹ç›®: ` + name);

  // å…‹éš†ä»£ç 
  await clone('github:yangxinquan0902/vue-template', name);

  log('å®‰è£…ä¾èµ–');

  // è§£å†³é—®é¢˜ï¼š[Error: spawn ENOENT]
  let comd = process.platform === "win32" ? "cnpm.cmd" : "cnpm";
  let comd2 = process.platform === "win32" ? "npm.cmd" : "npm";
  // child_process.spawn(command[, args][, options])
  await spawn(comd, ['install'], { cwd: `./${name}` }); // å‘½ä»¤è¡Œè‡ªåŠ¨è¿›å…¥./aaæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ cnpm i

  log(`
    ğŸ‘Œå®‰è£…å®Œæˆï¼š
    To get Start:
    ===========================
        cd ${name}
        npm run serve
    ===========================
  `);
  
  log('æ‰“å¼€æµè§ˆå™¨');
  
  open('http://localhost:8080');
  await spawn(comd2, ['run', 'serve'], { cwd: `./${name}` });

});

// è§£æå‘½ä»¤è¡Œå‚æ•°
program.parse(process.argv); 